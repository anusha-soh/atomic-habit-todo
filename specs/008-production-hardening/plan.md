# Implementation Plan: Production Hardening & Quality Fixes

**Branch**: `007-landing-page-update` (current branch)
**Date**: 2026-02-21
**Spec**: [spec.md](./spec.md)
**Research**: [research.md](./research.md)
**Data Model**: [data-model.md](./data-model.md)

---

## Summary

Fix all 35 issues identified in PROJECT_ANALYSIS.md across 4 phases, executed in dependency order. No database migrations required. Backend and frontend fixes are interleaved by priority rather than layer, ensuring the app is always in a working state after each phase.

**Approach**: Fix → Test → Verify. One concern per commit. Run full test suite after each phase.

---

## Technical Context

**Language/Version**: Python 3.13+ (backend), TypeScript 5.8+ (frontend)
**Primary Dependencies**: FastAPI 0.115+, Next.js 16, React 19, Tailwind CSS v4
**Storage**: Neon Serverless PostgreSQL — no schema changes
**Testing**: Pytest (backend), Vitest + Testing Library (frontend), Playwright (E2E — new)
**Target Platform**: Vercel (frontend), Render (backend)
**Performance Goals**: API response < 500ms p95, FCP < 1.2s
**Constraints**: No new breaking API changes, backward-compatible, single-branch delivery
**Scale/Scope**: Single-instance backend, ~100 concurrent users (current)

---

## Constitution Check

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Spec-Driven Development | ✅ PASS | All changes originate from spec + tasks |
| III. Modular Architecture | ✅ PASS | Fixes don't change module boundaries |
| IV. Event-Driven Design | ✅ PASS | EventEmitter fix improves observability, doesn't change contract |
| VI. Database as Source of Truth | ✅ PASS | UserContext fetches from API, not localStorage |
| VII. Mobile-First Design | ✅ PASS | Search UI and error boundaries use existing responsive patterns |
| VIII. API-First Architecture | ✅ PASS | Backend fixes first (Phase 1), UI follows (Phase 2+) |
| X. Test Specs, Not Implementation | ✅ PASS | Tests verify acceptance criteria from spec |
| XI. No Hardcoded Configuration | ✅ PASS | Removing hardcoded test-user-id is the point of FR-003 |
| XII. Composition Over Inheritance | ✅ PASS | Error boundaries use hooks + function components where possible |

**No violations. No complexity justification needed.**

---

## Project Structure

### Documentation (this feature)

```text
specs/008-production-hardening/
├── spec.md              ✅ Complete
├── plan.md              ✅ This file
├── research.md          ✅ Complete
├── data-model.md        ✅ Complete
├── quickstart.md        ✅ Complete
├── contracts/
│   ├── health-api.yaml              ✅ Complete
│   └── complete-task-enhanced.yaml  ✅ Complete
└── tasks.md             ⏳ Generated by /sp.tasks
```

### Affected Source Files

```text
apps/api/src/
├── main.py                          # Health endpoint, CORS, rate limiter setup
├── routes/
│   ├── auth.py                      # Rate limiting decorators
│   └── tasks.py                     # Habit sync error handling
├── services/
│   └── event_emitter.py             # logging module instead of print
├── routes/habits.py                 # Enum validation on update

apps/web/src/
├── app/
│   ├── layout.tsx                   # Add UserProvider, error.tsx
│   ├── error.tsx                    # NEW: root error boundary (Next.js pattern)
│   ├── tasks/
│   │   ├── page.tsx                 # Remove test-user-id, add search input
│   │   └── error.tsx                # NEW: tasks error boundary
│   ├── habits/
│   │   ├── page.tsx                 # Add debouncing to filters
│   │   └── error.tsx                # NEW: habits error boundary
│   ├── dashboard/
│   │   └── error.tsx                # NEW: dashboard error boundary
│   ├── login/
│   │   └── page.tsx                 # Update to use UserContext
│   └── register/
│       └── page.tsx                 # Update to use UserContext
├── contexts/
│   └── user-context.tsx             # NEW: UserProvider + useUser hook
├── components/
│   ├── RegisterForm.tsx             # Add password confirmation field
│   └── tasks/
│       ├── TaskForm.tsx             # Add tag autocomplete
│       └── TaskCard.tsx             # Optimistic updates on complete/delete
├── middleware.ts                    # Extend matcher, protect /tasks /habits
└── lib/
    ├── api.ts                       # Export single API_BASE constant
    ├── tasks-api.ts                 # Use imported API_BASE
    └── habits-api.ts                # Use imported API_BASE

tests/ (new E2E)
├── apps/web/e2e/
│   ├── auth.spec.ts                 # Register, login, logout
│   ├── tasks.spec.ts                # Task CRUD + search + complete
│   ├── habits.spec.ts               # Habit CRUD + complete + streak
│   └── landing.spec.ts             # Landing page CTA links
├── playwright.config.ts             # NEW: Playwright configuration
```

---

## Phase 1: Critical Fixes (Backend + Frontend)

**Goal**: Zero silent failures, no hardcoded values, real health checks.
**Risk**: Low — targeted single-file changes.

### 1.1 Fix Habit Sync Error Handling (C1)

**File**: `apps/api/src/routes/tasks.py` lines 406-408

**Change**:
```python
# BEFORE
except Exception:
    pass

# AFTER
except Exception as e:
    logger.warning(
        f"Habit sync failed for task {task_id}: {e}",
        exc_info=True
    )
    habit_sync_result["synced"] = False
    habit_sync_result["error"] = "Habit streak could not be updated. Please check your habit manually."
```

**Tests**: New unit test `test_complete_task_habit_sync_failure` — mock HabitService to raise, verify task still completes and response contains `habit_sync.synced=False, habit_sync.error=<message>`.

---

### 1.2 Real Health Endpoint (C2)

**File**: `apps/api/src/main.py` lines 108-115

**Change**:
```python
import time
_start_time = time.time()

@app.get("/health")
async def health(session: Session = Depends(get_session)):
    db_status = "disconnected"
    try:
        session.exec(text("SELECT 1"))
        db_status = "connected"
        http_status = 200
    except Exception:
        http_status = 503

    return JSONResponse(
        status_code=http_status,
        content={
            "status": "healthy" if db_status == "connected" else "unhealthy",
            "database": db_status,
            "version": "1.0.0",
            "uptime_seconds": round(time.time() - _start_time),
        }
    )
```

**Tests**: Integration test with mock DB failure returns 503.

---

### 1.3 Standardize API Base URL (C3)

**File**: `apps/web/src/lib/api.ts`

**Change**: Export `API_BASE` constant, normalize trailing slash.
```typescript
export const API_BASE = (
  process.env.NEXT_PUBLIC_API_URL ?? 'http://localhost:8000'
).replace(/\/$/, '')
```

**File**: `apps/web/src/lib/tasks-api.ts` line 15
```typescript
// BEFORE: const API_URL = 'http://localhost:8000/api'
// AFTER:
import { API_BASE } from './api'
const API_URL = `${API_BASE}/api`
```

**File**: `apps/web/src/lib/habits-api.ts` line 19
```typescript
// BEFORE: const API_URL = 'http://localhost:8000'
// AFTER:
import { API_BASE } from './api'
const API_URL = API_BASE   // habits-api already adds /api/ in each endpoint
```

**Tests**: Update `api.test.ts` and `tasks-api.test.ts` to mock `API_BASE`.

---

### 1.4 Remove Hardcoded test-user-id & Fix Middleware (C4)

**File**: `apps/web/src/app/tasks/page.tsx` lines 23-29
```typescript
// BEFORE
const userId = sessionCookie?.value || 'test-user-id';

// AFTER
if (!sessionCookie?.value) {
  redirect('/login')
}
const userId = sessionCookie.value
```

**File**: `apps/web/src/middleware.ts` — extend matcher
```typescript
export const config = {
  matcher: [
    '/dashboard/:path*',
    '/tasks/:path*',       // ADD
    '/habits/:path*',      // ADD
    '/login',
    '/register',
  ],
}
```

**Tests**: Add middleware unit test for unauthenticated `/tasks` redirect.

---

## Phase 2: Reliability & Security

**Goal**: Error boundaries on all pages, UserContext, rate limiting, EventEmitter logging, CORS fix, backend validation.

### 2.1 EventEmitter — Use Python logging (H1)

**File**: `apps/api/src/services/event_emitter.py` line 76

```python
# BEFORE
print(f"[EventEmitter] Failed to write event: {e}")

# AFTER
import logging
_logger = logging.getLogger(__name__)
_failure_count = 0
_FAILURE_THRESHOLD = 3

# In except block:
_failure_count += 1
level = logging.ERROR if _failure_count >= _FAILURE_THRESHOLD else logging.WARNING
_logger.log(level, f"EventEmitter write failed (count={_failure_count}): {e}", exc_info=True)
```

---

### 2.2 Rate Limiting on Auth Endpoints (H3)

**Dependency**: Add `slowapi>=0.1.9` to `apps/api/pyproject.toml`

**File**: `apps/api/src/main.py`
```python
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address
from slowapi.errors import RateLimitExceeded

limiter = Limiter(key_func=get_remote_address)
app.state.limiter = limiter
app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)
```

**File**: `apps/api/src/routes/auth.py`
```python
@router.post("/login")
@limiter.limit("10/minute")
async def login(request: Request, ...):
    ...

@router.post("/register")
@limiter.limit("5/5minute")
async def register(request: Request, ...):
    ...
```

---

### 2.3 CORS Header Restriction (M1)

**File**: `apps/api/src/main.py` line 92
```python
# BEFORE
allow_headers=["*"],

# AFTER
allow_headers=["Content-Type", "Authorization", "X-Requested-With"],
```

---

### 2.4 Backend Enum Validation on Update (H4)

**File**: `apps/api/src/routes/tasks.py` — ensure `TaskUpdateRequest` uses Pydantic enum types for `status` and `priority` (not raw `str`)
**File**: `apps/api/src/routes/habits.py` — ensure `HabitUpdateRequest.category` uses `HabitCategory` enum
**File**: Both schemas — add `description: Optional[str] = Field(None, max_length=5000)` to update request

---

### 2.5 UserProvider Context (H6)

**File**: `apps/web/src/contexts/user-context.tsx` (new)
```typescript
'use client'
import { createContext, useContext, useState, useEffect } from 'react'
import { authAPI } from '@/lib/auth-api'

interface UserContextValue {
  user: User | null
  isLoading: boolean
  error: string | null
  refetch: () => Promise<void>
}

const UserContext = createContext<UserContextValue | null>(null)

export function UserProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<User | null>(null)
  const [isLoading, setIsLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  const fetchUser = async () => {
    try {
      const data = await authAPI.me()
      setUser(data.user)
    } catch {
      setUser(null)
      setError('Authentication failed')
    } finally {
      setIsLoading(false)
    }
  }

  useEffect(() => { fetchUser() }, [])

  return (
    <UserContext.Provider value={{ user, isLoading, error, refetch: fetchUser }}>
      {children}
    </UserContext.Provider>
  )
}

export function useUser() {
  const ctx = useContext(UserContext)
  if (!ctx) throw new Error('useUser must be used within UserProvider')
  return ctx
}
```

**File**: `apps/web/src/app/layout.tsx` — add `<UserProvider>` wrapping `<ToastProvider>`

---

### 2.6 Error Boundaries — Next.js error.tsx Pattern (H5)

Create `error.tsx` files per route segment. These are auto-used by Next.js App Router:

**Files to create**:
- `apps/web/src/app/error.tsx` — root fallback
- `apps/web/src/app/tasks/error.tsx`
- `apps/web/src/app/habits/error.tsx`
- `apps/web/src/app/dashboard/error.tsx`

```typescript
// Each error.tsx (same pattern, different messages)
'use client'
export default function ErrorPage({
  error,
  reset,
}: {
  error: Error & { digest?: string }
  reset: () => void
}) {
  return (
    <div className="min-h-screen bg-notebook-paper flex items-center justify-center p-8">
      <div className="bg-white border-2 border-notebook-ink rounded-lg p-8 max-w-md text-center shadow-notebook-md">
        <h2 className="font-caveat text-2xl text-notebook-ink mb-4">
          Something went wrong
        </h2>
        <p className="font-patrick-hand text-notebook-ink-light mb-6">
          {error.message || 'An unexpected error occurred.'}
        </p>
        <button
          onClick={reset}
          className="bg-notebook-ink text-notebook-paper px-6 py-2 rounded font-patrick-hand hover:opacity-90"
        >
          Try again
        </button>
      </div>
    </div>
  )
}
```

---

### 2.7 Loading Skeletons on All Pages (H7)

Create `loading.tsx` per route segment (Next.js convention):
- `apps/web/src/app/habits/loading.tsx` — habit card skeletons (tasks page already has one)
- `apps/web/src/app/dashboard/loading.tsx` — dashboard skeleton

Use existing `NotebookSkeleton` component.

---

## Phase 3: Feature Completeness

**Goal**: Wire up existing backend capabilities to the UI.

### 3.1 Task Search UI (H8)

**File**: `apps/web/src/app/tasks/page.tsx`

Add a search input above the task list that sets `?search=` URL param. Server component reads `searchParams.search` and passes to `getTasks()`.

```tsx
// In the server component page
const search = searchParams?.search ?? ''
const tasks = await tasksAPI.getTasks(userId, { ...filters, search })
```

Add client-side `<SearchInput>` component that uses `useRouter` and `useSearchParams` to update the URL.

---

### 3.2 Tag Autocomplete in TaskForm (M11)

**File**: `apps/web/src/components/tasks/TaskForm.tsx`

- On mount, call `getTags(userId)` and store suggestions in state
- When user types in tag input, filter suggestions client-side
- Show dropdown of matching tags; clicking adds the tag

---

### 3.3 Filter Debouncing in Habits Page (M9)

**File**: `apps/web/src/app/habits/page.tsx`

```typescript
// Replace immediate API call on filter change with debounced version
const debounceRef = useRef<ReturnType<typeof setTimeout>>()

const handleFilterChange = (newFilters: Filters) => {
  clearTimeout(debounceRef.current)
  debounceRef.current = setTimeout(() => {
    fetchHabits(newFilters)
  }, 300)
}
```

---

### 3.4 Optimistic Task Updates (M8)

**File**: `apps/web/src/components/tasks/TaskCard.tsx`

On complete/delete:
1. Immediately remove/update item in local state (optimistic)
2. Call API
3. On failure: rollback state + show error toast

---

### 3.5 Password Confirmation Field (L5)

**File**: `apps/web/src/components/RegisterForm.tsx`

Add `confirmPassword` field. Validate `password === confirmPassword` before `handleSubmit`. Show error message inline if mismatch.

---

### 3.6 Timezone Standardization (M6)

**File**: `apps/api/src/services/streak_calculator.py` lines 56, 136

```python
# BEFORE
datetime.now().astimezone().tzinfo

# AFTER
from datetime import timezone
datetime.now(timezone.utc)
```

Apply same fix to any `datetime.now()` calls without timezone in the backend.

---

## Phase 4: Quality Assurance

**Goal**: E2E coverage, accessibility audit, verify all fixes via automated tests.

### 4.1 Playwright E2E Setup

**File**: `apps/web/playwright.config.ts` (new)
```typescript
import { defineConfig, devices } from '@playwright/test'

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  retries: process.env.CI ? 2 : 0,
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
  },
  projects: [
    { name: 'chromium', use: { ...devices['Desktop Chrome'] } },
    { name: 'Mobile Chrome', use: { ...devices['Pixel 5'] } },
  ],
  webServer: {
    command: 'pnpm dev:web',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
})
```

### 4.2 E2E Test Coverage

| Test File | Scenarios |
|-----------|-----------|
| `e2e/auth.spec.ts` | Register new user, login, logout, wrong password error |
| `e2e/tasks.spec.ts` | Create task, search by keyword, complete task, delete task |
| `e2e/habits.spec.ts` | Create habit, complete habit, verify streak increment |
| `e2e/landing.spec.ts` | CTA links to /register and /login, nav scroll state |
| `e2e/error.spec.ts` | Navigate to protected route unauthenticated → redirect to login |

### 4.3 Accessibility Audit

Run Lighthouse CLI against all pages:
```bash
npx lighthouse http://localhost:3000 --output=json --only-categories=accessibility
npx lighthouse http://localhost:3000/login --output=json --only-categories=accessibility
npx lighthouse http://localhost:3000/dashboard --output=json --only-categories=accessibility
```

Target: Accessibility score >= 90 on all pages.

Fix any failures before marking Phase 4 complete.

---

## Implementation Order (Dependency Graph)

```
Phase 1 (Critical — must do first, unblocks everything)
  1.3 API Base URL  →  1.4 Remove test-user-id (depends on auth working)
  1.1 Habit Sync Fix  (independent)
  1.2 Health Endpoint  (independent)

Phase 2 (Reliability — can be done in parallel per item)
  2.1 EventEmitter  (independent)
  2.5 UserProvider  →  2.6 Error Boundaries (UserProvider must be in layout first)
  2.2 Rate Limiting  →  requires slowapi installed
  2.3 CORS Fix  (independent, 1 line change)
  2.4 Validation  (independent)
  2.7 Loading States  (independent)

Phase 3 (Features — depends on Phase 1 & 2 complete)
  3.1 Search UI  (depends on API URL fix from 1.3)
  3.2 Tag Autocomplete  (depends on API URL fix from 1.3)
  3.3 Debouncing  (independent)
  3.4 Optimistic Updates  (independent)
  3.5 Password Confirm  (independent)
  3.6 Timezone Fix  (independent)

Phase 4 (QA — depends on all above)
  4.1 Playwright Setup
  4.2 E2E Tests
  4.3 Accessibility Audit + Fixes
```

---

## Risk Register

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| API URL change breaks existing tests | Medium | High | Run full Vitest suite after 1.3; update mocks |
| Rate limiter locks out developer during testing | Low | Medium | Use `TEST_MODE=true` to disable rate limits in test env |
| UserProvider causes SSR hydration issues | Low | Medium | Mark as `'use client'`; test with SSR disabled first |
| Error boundary swallows important errors | Low | Low | Always log to console in development |
| Playwright flaky E2E tests in CI | Medium | Low | Use `retries: 2` and stable selectors |

---

## Definition of Done

- [ ] All 4 Critical issues resolved with tests
- [ ] All 10 High issues resolved with tests
- [ ] All 12 Medium issues resolved (or documented as deferred with reason)
- [ ] Existing 44 test files pass (zero regressions)
- [ ] E2E tests pass on Chromium and Mobile Chrome
- [ ] Lighthouse accessibility score ≥ 90 on all pages
- [ ] `PROJECT_ANALYSIS.md` updated to mark resolved issues
- [ ] PHR created for this plan
