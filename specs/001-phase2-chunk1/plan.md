# Implementation Plan: Phase 2 Core Infrastructure

**Branch**: `001-phase2-chunk1` | **Date**: 2026-01-03 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-phase2-chunk1/spec.md`

**Note**: This template is filled in by the `/sp.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

This feature establishes the foundational infrastructure for Phase 2 of the Atomic Habits todo application. It implements multi-user authentication, database persistence, monorepo structure, and event system skeleton. This chunk provides the platform upon which all subsequent Phase 2 features (tasks and habits modules) will be built.

## Technical Context

**Language/Version**:
- Backend: Python 3.13+
- Frontend: TypeScript 5.8+ (strict mode)
- Node.js: 20+

**Primary Dependencies**:
- Backend: FastAPI, SQLModel (ORM), Alembic (migrations), Better Auth, Pydantic, UV (package manager)
- Frontend: Next.js 16+ (App Router), React, TailwindCSS 4+, Radix UI
- Database: Neon Serverless PostgreSQL
- Monorepo: pnpm workspace

**Storage**:
- Database: Neon Serverless PostgreSQL (hosted)
- Event Logs: File-based JSON lines (logs/ directory, rotatable)
- Session Storage: Database-backed (sessions table) + httpOnly cookies

**Testing**:
- Backend: pytest (unit, API, integration)
- Frontend: Jest + React Testing Library
- Contract Testing: OpenAPI schema validation

**Target Platform**:
- Backend: Linux server (Render deployment)
- Frontend: Browser (Vercel deployment, mobile-first responsive)
- Database: Cloud-hosted PostgreSQL (Neon)

**Project Type**: Web application (monorepo: apps/web + apps/api + packages/core)

**Performance Goals**:
- Registration/Login: < 2 seconds response time
- Database migrations: < 10 seconds
- JWT token validation: < 100ms per request
- Frontend page load: < 3 seconds (FCP)

**Constraints**:
- Mobile-first design (minimum 320px screen width)
- Touch targets: minimum 44×44px
- JWT tokens: 7-day expiration
- Password: minimum 8 characters (no composition rules)
- Protected routes: redirect to /login within 500ms if unauthenticated

**Scale/Scope**:
- Multi-user system (isolated user data)
- Database: supports concurrent connections
- Event system: fire-and-forget, file-based logging
- Frontend: 3 pages (register, login, dashboard)
- Backend: 4 API endpoints (register, login, logout, me)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Immutable Principles Review

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Spec-Driven Development is Mandatory | ✅ PASS | This plan follows spec → plan → tasks workflow. All code will be generated by Claude Code from specifications. |
| II. User Identity Drives Behavior | ⚠️ N/A for Chunk 1 | This chunk focuses on authentication infrastructure. Identity-based language will be implemented in Chunk 3 (Habits MVP). |
| III. Modular Architecture with Feature Flags | ✅ PASS | Core module (auth, events, database) designed to work standalone. Habits module will be separate (Chunks 3-5). |
| IV. Event-Driven Design from Phase II Onwards | ✅ PASS | Event emitter skeleton included in this chunk. Events emitted for USER_REGISTERED, USER_LOGGED_IN, USER_LOGGED_OUT. |
| V. Every Habit Feature Maps to the Four Laws | ⚠️ N/A for Chunk 1 | No habit features in this chunk. Four Laws mapping begins in Chunk 3. |
| VI. Database as Single Source of Truth | ✅ PASS | All backend services stateless. State persists in Neon PostgreSQL. Sessions tracked in database. JWT in httpOnly cookies. |
| VII. Mobile-First Responsive Design | ✅ PASS | All UI components designed mobile-first (320px minimum). Touch targets 44×44px. Bottom navigation for mobile. |
| VIII. API-First Architecture | ✅ PASS | FastAPI backend with auto-generated OpenAPI spec. Backend endpoints documented before frontend development. |
| IX. Progressive Complexity Across Phases | ✅ PASS | This is Phase 2 Chunk 1. No Phase 3+ features included. Focused on infrastructure only. |
| X. Test Specs, Not Implementation | ✅ PASS | Tests will verify acceptance criteria from spec (registration success, login flow, JWT validation). |
| XI. No Hardcoded Configuration | ✅ PASS | All config in environment variables: DATABASE_URL, BETTER_AUTH_SECRET, NEXT_PUBLIC_API_URL. .env.example provided. |
| XII. Composition Over Inheritance | ✅ PASS | SQLModel uses mixins. React uses hooks. FastAPI uses dependency injection. No deep inheritance hierarchies. |

### Forbidden Patterns Check

| Pattern | Risk | Mitigation |
|---------|------|------------|
| ❌ localStorage for Critical Data | Low | JWT stored in httpOnly cookies. Session data in database. localStorage only for non-critical preferences (future). |
| ❌ Manual Code Writing | None | All code generated via Claude Code from specs. |
| ❌ Tight Coupling Between Modules | None | Core module isolated. Habits module (future chunks) will communicate via events only. |
| ❌ Skipping Phases | None | This is Phase 2 Chunk 1. Phase 1 completed and tagged. |
| ❌ Synchronous Event Handling | None | Event emitter designed as fire-and-forget (asynchronous). |
| ❌ Database Schema Changes Without Migrations | None | Alembic migrations required for all schema changes (users, sessions tables). |

### Overall Assessment

**Status**: ✅ **PASS** - All applicable principles satisfied. No forbidden patterns detected.

**Justifications for N/A items**:
- Principles II and V relate to habit features, which are out of scope for Chunk 1 (infrastructure only).
- These principles will be enforced starting in Chunk 3 (Habits MVP).

**No complexity violations requiring justification.**

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/sp.plan command output)
├── research.md          # Phase 0 output (/sp.plan command)
├── data-model.md        # Phase 1 output (/sp.plan command)
├── quickstart.md        # Phase 1 output (/sp.plan command)
├── contracts/           # Phase 1 output (/sp.plan command)
└── tasks.md             # Phase 2 output (/sp.tasks command - NOT created by /sp.plan)
```

### Source Code (repository root)

```text
# Monorepo Structure (pnpm workspace)
/
├── apps/
│   ├── web/                      # Next.js 16+ frontend
│   │   ├── src/
│   │   │   ├── app/              # App Router pages
│   │   │   │   ├── register/
│   │   │   │   ├── login/
│   │   │   │   └── dashboard/
│   │   │   ├── components/       # React components
│   │   │   └── lib/              # Frontend utilities
│   │   ├── public/               # Static assets
│   │   ├── package.json
│   │   └── tsconfig.json
│   │
│   └── api/                      # FastAPI backend
│       ├── src/
│       │   ├── models/           # SQLModel database models
│       │   │   ├── user.py
│       │   │   └── session.py
│       │   ├── routes/           # API endpoints
│       │   │   └── auth.py       # /api/auth/* endpoints
│       │   ├── services/         # Business logic
│       │   │   ├── auth_service.py
│       │   │   └── event_emitter.py
│       │   ├── middleware/       # JWT validation, CORS
│       │   └── main.py           # FastAPI app entry
│       ├── tests/
│       │   ├── unit/
│       │   ├── integration/
│       │   └── contract/         # OpenAPI schema tests
│       ├── alembic/              # Database migrations
│       │   └── versions/
│       ├── pyproject.toml        # UV dependencies
│       └── alembic.ini
│
├── packages/
│   └── core/                     # Shared types/utilities
│       ├── src/
│       │   ├── types/            # Shared TypeScript types
│       │   └── constants/
│       └── package.json
│
├── logs/                         # Event logs (gitignored)
│   └── events-YYYY-MM-DD.jsonl
│
├── specs/                        # Feature specifications
│   └── 001-phase2-chunk1/
│       ├── spec.md
│       ├── plan.md               # This file
│       ├── research.md           # Phase 0 output
│       ├── data-model.md         # Phase 1 output
│       ├── quickstart.md         # Phase 1 output
│       └── contracts/            # Phase 1 output
│
├── pnpm-workspace.yaml           # pnpm workspace config
├── package.json                  # Root package.json
├── .env.example                  # Environment variable template
└── .gitignore
```

**Structure Decision**:

This feature uses **Monorepo (Option 2: Web application)** structure with pnpm workspaces.

**Rationale**:
1. **Clear Separation**: Frontend (apps/web) and backend (apps/api) are independently deployable
2. **Shared Code**: packages/core contains shared TypeScript types and constants
3. **Independent Dependencies**: Each app has its own package.json/pyproject.toml
4. **Deployment Alignment**:
   - apps/web → Vercel (automatic Next.js detection)
   - apps/api → Render (Python deployment)
5. **Future Scalability**: Easy to add apps/chatbot (Phase 3) or packages/habits (Chunks 3-5) without restructuring

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

**No violations detected.** All design decisions align with constitutional principles.

---

## Post-Design Constitution Check

*Re-evaluation after Phase 0 (research.md) and Phase 1 (data-model.md, contracts, quickstart.md) completion.*

### Design Decisions Review

| Decision | Constitutional Alignment | Status |
|----------|--------------------------|--------|
| Better Auth + JWT in httpOnly cookies | Principle VI (Database as single source) + XI (No hardcoded config) | ✅ PASS |
| Neon PostgreSQL + Alembic + SQLModel | Principle VI (Stateless services, DB as truth) | ✅ PASS |
| pnpm workspaces (monorepo) | Principle III (Modular architecture) + VIII (API-first) | ✅ PASS |
| File-based event logging | Principle IV (Event-driven design) | ✅ PASS |
| Next.js 16 App Router + TailwindCSS | Principle VII (Mobile-first) + XII (Composition over inheritance) | ✅ PASS |
| OpenAPI contract-first | Principle VIII (API-first architecture) + X (Test specs, not implementation) | ✅ PASS |
| Environment variables for config | Principle XI (No hardcoded configuration) | ✅ PASS |
| UUID primary keys | Principle VI (Database as single source) - supports distributed systems | ✅ PASS |
| bcrypt password hashing | Industry standard (OWASP recommended) | ✅ PASS |

### Architectural Patterns Review

| Pattern | Justification | Status |
|---------|---------------|--------|
| Monorepo structure | Clear separation (apps/web, apps/api, packages/core), independent deployment, shared types | ✅ PASS |
| Event emitter (fire-and-forget) | Non-blocking, async, aligns with Principle IV | ✅ PASS |
| Database-backed sessions | Enables server-side invalidation (logout), aligns with Principle VI | ✅ PASS |
| Mobile-first responsive design | Touch targets 44×44px, bottom navigation, aligns with Principle VII | ✅ PASS |
| Contract tests (OpenAPI) | Tests verify API contract, not implementation, aligns with Principle X | ✅ PASS |

### Anti-Patterns Check

| Anti-Pattern | Risk | Mitigation |
|--------------|------|------------|
| ❌ localStorage for JWT | **AVOIDED** | JWT stored in httpOnly cookies (XSS protection) |
| ❌ Plaintext passwords | **AVOIDED** | bcrypt hashing before storage (Better Auth default) |
| ❌ Hardcoded API URLs | **AVOIDED** | Environment variables (NEXT_PUBLIC_API_URL, ALLOWED_ORIGINS) |
| ❌ Tight coupling (Core ↔ Habits) | **AVOIDED** | Event-driven communication planned for Chunk 3+ |
| ❌ Synchronous event handling | **AVOIDED** | Fire-and-forget async event emitter |
| ❌ Schema changes without migrations | **AVOIDED** | Alembic migration workflow enforced |

### Overall Post-Design Assessment

**Status**: ✅ **PASS** - All design decisions align with constitutional principles. No forbidden patterns introduced.

**Key Architectural Strengths**:
1. **Stateless Services**: Backend can be horizontally scaled (Principle VI)
2. **Event-Driven Foundation**: Event emitter skeleton ready for Chunks 3-5 (Principle IV)
3. **API-First**: OpenAPI contract enables frontend/backend parallel development (Principle VIII)
4. **Mobile-First**: TailwindCSS breakpoints + 44×44px touch targets (Principle VII)
5. **Security-First**: httpOnly cookies, bcrypt, CORS, environment variables (Principles VI, XI)

**No ADR required**: All decisions align with existing constitutional principles. No new architectural patterns introduced that require justification.
