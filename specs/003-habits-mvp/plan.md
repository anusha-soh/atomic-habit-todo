# Implementation Plan: Habits MVP

**Branch**: `003-habits-mvp` | **Date**: 2026-02-10 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/003-habits-mvp/spec.md`

**Note**: This plan was generated by the `/sp.plan` command following Phase 0 (Research) and Phase 1 (Design) workflows.

## Summary

Build a comprehensive habit management system implementing the Atomic Habits Four Laws framework. The system will allow users to create identity-driven habits with 2-minute starter versions, habit stacking cues, and flexible recurring schedules. This feature integrates with the existing tasks system through event-driven architecture and provides the foundation for future habit tracking and streak management (Phase 2 Chunk 4).

## Technical Context

**Language/Version**: Python 3.13+ (backend), TypeScript 5.8+ (frontend)
**Primary Dependencies**: FastAPI, SQLModel, Next.js 16+, TailwindCSS 4+
**Storage**: Neon Serverless PostgreSQL (JSONB for recurring schedules, ARRAY for tags)
**Testing**: pytest (backend), Jest + React Testing Library (frontend)
**Target Platform**: Web application (Vercel frontend, Render backend)
**Project Type**: Web (monorepo: apps/api + apps/web)
**Performance Goals**:
  - API response < 200ms p95 for list operations
  - Habit creation < 100ms p95
  - Frontend render < 500ms for 20 habits
**Constraints**:
  - PostgreSQL required (JSONB/ARRAY not compatible with SQLite)
  - User isolation enforced at database query level
  - All state in database (stateless services)
  - Event-driven communication only
**Scale/Scope**:
  - Phase 2: Up to 10,000 users
  - 5-20 habits per user (100 max)
  - Total ~100,000 habit records
  - Database size < 50 MB

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### ‚úÖ Immutable Principles Compliance

| Principle | Status | Notes |
|-----------|--------|-------|
| **I. Spec-Driven Development** | ‚úÖ PASS | All code generated from spec ‚Üí plan ‚Üí tasks workflow |
| **II. User Identity Drives Behavior** | ‚úÖ PASS | `identity_statement` field required, "I am a person who..." pattern enforced |
| **III. Modular Architecture** | ‚úÖ PASS | Habits module separate from Core, event-driven communication |
| **IV. Event-Driven Design** | ‚úÖ PASS | HABIT_CREATED/UPDATED/DELETED events emitted, no direct table access |
| **V. Four Laws Mapping** | ‚úÖ PASS | Each feature maps to Atomic Habits laws (see data-model.md) |
| **VI. Database as Source of Truth** | ‚úÖ PASS | Stateless services, all state in PostgreSQL |
| **VII. Mobile-First Design** | ‚úÖ PASS | TailwindCSS mobile-first breakpoints, responsive UI |
| **VIII. API-First Architecture** | ‚úÖ PASS | OpenAPI contract defined before frontend (contracts/habits-api.yaml) |
| **IX. Progressive Complexity** | ‚úÖ PASS | Phase 2 Chunk 3 scope, no Phase V features included |
| **X. Test Specs, Not Implementation** | ‚úÖ PASS | Tests map to acceptance criteria from spec.md |
| **XI. No Hardcoded Configuration** | ‚úÖ PASS | Environment variables for DATABASE_URL, feature flags |
| **XII. Composition Over Inheritance** | ‚úÖ PASS | Utility functions, Pydantic validators, no class hierarchies |

### ‚úÖ Architectural Constraints

| Constraint | Status | Implementation |
|------------|--------|----------------|
| **Core + Habits Modules** | ‚úÖ PASS | Habits module isolated, events-only communication |
| **Event Bus** | ‚úÖ PASS | EventEmitter file-based logging (Phase 2 pattern) |
| **Stateless Services** | ‚úÖ PASS | HabitService has no in-memory state |
| **Mobile-First UI** | ‚úÖ PASS | Next.js components with mobile-first CSS |
| **API-First** | ‚úÖ PASS | FastAPI routes with OpenAPI auto-generation |
| **No localStorage for Critical Data** | ‚úÖ PASS | All habit data in database via API |
| **No Tight Coupling** | ‚úÖ PASS | Habits module imports only core types, no direct DB access |

### ‚úÖ Forbidden Patterns - Avoided

| Anti-Pattern | Status | Mitigation |
|--------------|--------|------------|
| **Manual Code Writing** | ‚úÖ AVOIDED | All code generated via Claude Code from tasks |
| **Skipping Phases** | ‚úÖ AVOIDED | Phase 2 Chunk 3 only, no Chunk 4 features (streaks deferred) |
| **Tight Module Coupling** | ‚úÖ AVOIDED | Events-only communication, no direct imports |
| **Synchronous Event Handling** | ‚úÖ AVOIDED | Fire-and-forget event emission |
| **Hardcoded Config** | ‚úÖ AVOIDED | Environment variables for all config |
| **localStorage for State** | ‚úÖ AVOIDED | Database as source of truth |

### üéØ Phase 2 Scope Alignment

**In Scope (Chunk 3)**:
- ‚úÖ Habit CRUD operations
- ‚úÖ Identity-driven habit creation ("I am a person who...")
- ‚úÖ 2-minute version (Law 3: Make It Easy)
- ‚úÖ Habit stacking cues (Law 1: Make It Obvious)
- ‚úÖ Category management (predefined categories)
- ‚úÖ Recurring schedule (daily/weekly/monthly)
- ‚úÖ Status (active/archived)
- ‚úÖ Event emission (HABIT_CREATED/UPDATED/DELETED)

**Out of Scope (Deferred to Chunk 4)**:
- ‚ùå Habit completion logging
- ‚ùå Streak calculation
- ‚ùå Never miss twice logic
- ‚ùå Notifications
- ‚ùå Task generation from habits

**Out of Scope (Post-Phase V)**:
- ‚ùå Implementation intentions (time/location triggers)
- ‚ùå Habit bundles
- ‚ùå Tracking calendar heatmap
- ‚ùå Milestone celebrations
- ‚ùå Voice commands

**Gate Status**: ‚úÖ **APPROVED** - All constitutional requirements satisfied

## Project Structure

### Documentation (this feature)

```text
specs/003-habits-mvp/
‚îú‚îÄ‚îÄ spec.md              # Feature specification (User Stories, Requirements)
‚îú‚îÄ‚îÄ plan.md              # This file (Architectural plan)
‚îú‚îÄ‚îÄ research.md          # Phase 0 output (Technical research & decisions)
‚îú‚îÄ‚îÄ data-model.md        # Phase 1 output (Database schema, SQLModel)
‚îú‚îÄ‚îÄ quickstart.md        # Phase 1 output (Developer quickstart guide)
‚îú‚îÄ‚îÄ contracts/           # Phase 1 output (API contracts)
‚îÇ   ‚îî‚îÄ‚îÄ habits-api.yaml  # OpenAPI 3.1 specification
‚îî‚îÄ‚îÄ tasks.md             # Phase 2 output (/sp.tasks command - NOT YET CREATED)
```

### Source Code (repository root)

**Web Application Structure** (Monorepo):

```text
apps/
‚îú‚îÄ‚îÄ api/                                 # FastAPI Backend
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.py                  # Existing (Phase 2 Chunk 1)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ task.py                  # Existing (Phase 2 Chunk 2)
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ habit.py                 # NEW - Habit SQLModel + RecurringSchedule
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ event_emitter.py         # Existing (Phase 2 Chunk 1)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ task_service.py          # Existing (Phase 2 Chunk 2)
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ habit_service.py         # NEW - Business logic (CRUD, validation)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.py                  # Existing (Phase 2 Chunk 1)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tasks.py                 # Existing (Phase 2 Chunk 2)
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ habits.py                # NEW - REST endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ habit_schemas.py         # NEW - Request/response Pydantic models
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.py                  # Existing (Phase 2 Chunk 1)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py                    # Existing (Phase 2 Chunk 1)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.py                      # MODIFY - Register habits router
‚îÇ   ‚îú‚îÄ‚îÄ alembic/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ versions/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ 003_create_habits_table.py  # NEW - Database migration
‚îÇ   ‚îî‚îÄ‚îÄ tests/
‚îÇ       ‚îú‚îÄ‚îÄ unit/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ test_habit_model.py      # NEW - Model validation tests
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ test_habit_service.py    # NEW - Service logic tests
‚îÇ       ‚îî‚îÄ‚îÄ integration/
‚îÇ           ‚îî‚îÄ‚îÄ test_habit_routes.py     # NEW - API endpoint tests
‚îÇ
‚îî‚îÄ‚îÄ web/                                 # Next.js Frontend
    ‚îú‚îÄ‚îÄ src/
    ‚îÇ   ‚îú‚îÄ‚îÄ app/
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ (authenticated)/
    ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ tasks/               # Existing (Phase 2 Chunk 2)
    ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ habits/              # NEW - Habits feature
    ‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ page.tsx         # NEW - Habits list page
    ‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ new/
    ‚îÇ   ‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx     # NEW - Create habit page
    ‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ [id]/
    ‚îÇ   ‚îÇ               ‚îî‚îÄ‚îÄ page.tsx     # NEW - Habit detail/edit page
    ‚îÇ   ‚îú‚îÄ‚îÄ components/
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tasks/                   # Existing (Phase 2 Chunk 2)
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ habits/                  # NEW - Habit components
    ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ HabitCard.tsx        # NEW - Habit card component
    ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ HabitForm.tsx        # NEW - Create/edit form
    ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ CategoryFilter.tsx   # NEW - Category filter
    ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ StatusFilter.tsx     # NEW - Active/archived filter
    ‚îÇ   ‚îî‚îÄ‚îÄ lib/
    ‚îÇ       ‚îî‚îÄ‚îÄ api/
    ‚îÇ           ‚îú‚îÄ‚îÄ tasks.ts             # Existing (Phase 2 Chunk 2)
    ‚îÇ           ‚îî‚îÄ‚îÄ habits.ts            # NEW - API client functions
    ‚îî‚îÄ‚îÄ __tests__/
        ‚îî‚îÄ‚îÄ habits/
            ‚îú‚îÄ‚îÄ HabitForm.test.tsx       # NEW - Form component tests
            ‚îî‚îÄ‚îÄ habits-page.test.tsx     # NEW - Page integration tests
```

**Structure Decision**:

This is a **Web Application (Monorepo)** structure following the existing Phase 2 pattern established in Chunks 1-2. The habits feature is implemented as a **modular addition** to the existing system:

- **Backend**: New `habit.py` model, `habit_service.py` business logic, `habits.py` routes added alongside existing task modules
- **Frontend**: New `app/(authenticated)/habits/` pages and `components/habits/` alongside existing task pages
- **Event-Driven**: Uses existing `event_emitter.py` service with new HABIT_* events
- **Database**: New `habits` table created via Alembic migration, separate from `tasks` table
- **Testing**: Follows existing test organization pattern (unit, integration, contract tests)

This structure maintains **module independence** per Constitution Principle III, with habits and tasks communicating only via events.

## Complexity Tracking

> **No constitutional violations requiring justification**

All design decisions align with constitutional principles. No additional complexity introduced beyond what is required by the feature specification.

---

## Key Architectural Decisions

### 1. Data Model Design

**Decision**: Use JSONB for `recurring_schedule` field

**Rationale**:
- **Flexibility**: Supports daily/weekly/monthly patterns without schema changes
- **Queryability**: PostgreSQL JSONB allows indexed queries on schedule type
- **Extensibility**: Future schedule types (e.g., "every 2 weeks") don't require migrations
- **Performance**: GIN indexes provide efficient JSONB queries

**Alternatives Considered**:
- Separate `schedules` table with type-specific columns ‚Üí Rejected: Requires complex JOINs, harder to validate
- Enum + separate fields (daily_until, weekly_days, etc.) ‚Üí Rejected: Schema bloat, hard to extend
- String serialization (JSON text) ‚Üí Rejected: No query support, no type safety

**Tradeoffs**:
- ‚úÖ Pros: Flexible, queryable, extensible
- ‚ùå Cons: Requires PostgreSQL (no SQLite support), JSONB learning curve

**References**: [research.md#recurring-schedule-design](./research.md#2-recurring-schedule-design)

---

### 2. Habit Stacking Implementation

**Decision**: Use foreign key (`anchor_habit_id`) with `ON DELETE SET NULL`

**Rationale**:
- **Referential Integrity**: Prevents linking to non-existent habits
- **Graceful Degradation**: When anchor deleted, dependent habits retain `habit_stacking_cue` text but lose link
- **Queryability**: Can query "all habits stacked on X" efficiently
- **User Warning**: Can detect dependencies before deletion

**Alternatives Considered**:
- Store anchor as text (no foreign key) ‚Üí Rejected: No integrity, stale references
- `ON DELETE CASCADE` ‚Üí Rejected: Deleting anchor shouldn't delete dependent habits
- `ON DELETE RESTRICT` ‚Üí Rejected: Prevents deletion even if user confirms

**Tradeoffs**:
- ‚úÖ Pros: Data integrity, graceful degradation, queryable
- ‚ùå Cons: Requires validation logic, migration complexity

**Validation**: Circular dependency prevention algorithm (see research.md#3.3)

**References**: [research.md#habit-stacking-implementation](./research.md#3-habit-stacking-implementation)

---

### 3. Category Management

**Decision**: Fixed predefined categories (VARCHAR enum) for Phase 2

**Rationale**:
- **Simplicity**: No additional tables, simple validation
- **User Experience**: Pre-populated dropdown, consistent categorization
- **Phase 2 Scope**: Meets MVP requirements without over-engineering

**Alternatives Considered**:
- Custom user-defined categories ‚Üí Rejected: Complexity not justified for Phase 2
- `habit_categories` table with predefined + custom ‚Üí Rejected: Deferred to Post-Phase V

**Categories**: Health & Fitness, Productivity, Mindfulness, Learning, Social, Finance, Creative, Other

**Future Extensibility**: Migration path to custom categories documented in data-model.md

**References**: [research.md#category-management](./research.md#5-category-management)

---

### 4. Event-Driven Integration

**Decision**: Use existing EventEmitter file-based logging (Phase 2 pattern)

**Rationale**:
- **Consistency**: Matches task events pattern from Chunk 2
- **Phase Alignment**: File-based events sufficient for Phase 2 (Kafka in Phase V)
- **Decoupling**: Enables future modules to subscribe to habit events

**Events Emitted**:
- `HABIT_CREATED` - After habit creation
- `HABIT_UPDATED` - After habit modification
- `HABIT_DELETED` - After habit deletion
- `HABIT_ARCHIVED` - When status changed to archived
- `HABIT_RESTORED` - When status changed to active

**Event Schema**:
```python
{
    "event_type": "HABIT_CREATED",
    "user_id": "uuid",
    "timestamp": "2026-02-10T10:00:00Z",
    "payload": {
        "habit_id": "uuid",
        "identity_statement": "I am a person who...",
        "category": "Learning",
        "recurring_schedule": {...}
    }
}
```

**References**: [research.md#event-schema](./research.md#7-event-schema)

---

### 5. Status Management (Active/Archived)

**Decision**: Two-state status enum with default filtering

**Rationale**:
- **Preservation**: Archive preserves historical data (vs delete)
- **Simplicity**: Two states cover Phase 2 requirements
- **Reversibility**: Users can restore archived habits

**Default Behavior**: List views exclude archived habits unless explicitly requested

**Archive vs Delete**:
- **Archive**: Soft delete, preserves data, reversible
- **Delete**: Hard delete, cascades to completions, warns about dependencies

**References**: [research.md#status-and-archiving](./research.md#4-status-and-archiving)

---

## Implementation Phases

### Phase 0: Research (Complete)

**Deliverable**: `research.md`

**Completed**:
- ‚úÖ Database schema design (habits + habit_completions tables)
- ‚úÖ Recurring schedule JSONB format
- ‚úÖ Habit stacking foreign key approach
- ‚úÖ Category management strategy
- ‚úÖ API contract design
- ‚úÖ Event schema definition
- ‚úÖ Best practices documentation (SQLModel pitfalls, imports, testing)

---

### Phase 1: Design (Complete)

**Deliverables**: `data-model.md`, `contracts/habits-api.yaml`, `quickstart.md`

**Completed**:
- ‚úÖ Data model with SQLModel implementation
- ‚úÖ Entity relationship diagram
- ‚úÖ Field specifications with validators
- ‚úÖ OpenAPI 3.1 contract (REST endpoints)
- ‚úÖ Request/response schemas
- ‚úÖ Developer quickstart guide
- ‚úÖ Testing strategy

---

### Phase 2: Task Generation (Next Step)

**Command**: `/sp.tasks`

**Deliverable**: `tasks.md`

**Task Categories**:
- **T001-T010**: Database & Models (Alembic migration, Habit model, validators)
- **T011-T020**: Business Logic (HabitService CRUD, circular dependency validation)
- **T021-T030**: API Endpoints (FastAPI routes, request/response handling)
- **T031-T050**: Testing (Unit tests, integration tests, contract tests)
- **T051-T070**: Frontend (Pages, components, API client, forms)
- **T071-T080**: Integration (Event emission, error handling, polish)

---

## Testing Strategy

### Unit Tests (apps/api/tests/unit/)

**test_habit_model.py**:
- Field validation (identity_statement, two_minute_version required)
- Category enum validation
- Status enum validation
- RecurringSchedule validation (type-specific rules)
- Foreign key constraints

**test_habit_service.py**:
- CRUD operations (create, read, update, delete)
- User isolation (cannot access other users' habits)
- Circular dependency prevention
- Archive/restore logic
- Event emission verification

**Coverage Target**: 90%+ for models and services

---

### Integration Tests (apps/api/tests/integration/)

**test_habit_routes.py**:
- POST `/api/{user_id}/habits` - Create (201 Created)
- POST with invalid data - Validation error (400 Bad Request)
- GET `/api/{user_id}/habits` - List (200 OK)
- GET with filters (status, category) - Filtered results
- GET `/api/{user_id}/habits/{id}` - Single habit (200 OK)
- GET non-existent habit - Not found (404)
- PATCH `/api/{user_id}/habits/{id}` - Update (200 OK)
- PATCH with invalid data - Validation error (400)
- DELETE `/api/{user_id}/habits/{id}` - Delete (200 OK)
- DELETE with dependencies - Warning (400 with dependent list)

**Authentication/Authorization**:
- Requires valid JWT token
- Users can only access their own habits
- Unauthorized access returns 401/403

**Coverage Target**: 100% of API endpoints

---

### Frontend Tests (apps/web/__tests__/)

**HabitForm.test.tsx**:
- Form validation (required fields)
- Identity statement pre-fill
- Category dropdown
- Recurring schedule builder
- Submit handling

**habits-page.test.tsx**:
- List rendering
- Filtering (category, status)
- Navigation to create/edit
- Empty state display

**Coverage Target**: 80%+ for components and pages

---

## Performance & Scalability

### API Performance Targets

| Operation | Target | Measurement |
|-----------|--------|-------------|
| List habits (50 items) | < 200ms p95 | Total API response time |
| Create habit | < 100ms p95 | Database INSERT + event write |
| Update habit | < 100ms p95 | Database UPDATE + event write |
| Delete habit | < 100ms p95 | Dependency check + DELETE |

### Database Optimization

**Indexes**:
- `idx_habits_user_id` - For user isolation queries
- `idx_habits_user_status` - For filtered lists (active/archived)
- `idx_habits_user_category` - For category filtering
- `idx_habits_anchor` - For dependency lookups
- `idx_habits_schedule` (GIN) - For JSONB schedule queries

**Query Patterns**:
```sql
-- Most common query (list active habits)
SELECT * FROM habits WHERE user_id = ? AND status = 'active' ORDER BY created_at DESC;

-- Filter by category
SELECT * FROM habits WHERE user_id = ? AND status = 'active' AND category = ?;

-- Find dependencies (before delete)
SELECT * FROM habits WHERE anchor_habit_id = ?;

-- Query by schedule type
SELECT * FROM habits WHERE recurring_schedule->>'type' = 'daily';
```

### Frontend Performance

**Initial Load**: < 500ms for 20 habits
**Form Render**: < 100ms
**Client-Side Validation**: < 50ms

---

## Security & Privacy

### User Isolation

**Enforcement Points**:
1. **Database Queries**: All queries include `WHERE user_id = {authenticated_user_id}`
2. **API Routes**: Middleware validates `user_id` in path matches JWT claims
3. **Foreign Keys**: `user_id` on habits table with CASCADE on user deletion

**Testing**: Integration tests verify users cannot access/modify others' habits

### Data Privacy

- No PII beyond user association
- Habit content is user-generated and private
- Event logs include `user_id` for auditing
- No third-party data sharing (Phase 2)

### Input Validation

**Server-Side** (FastAPI + Pydantic):
- Required fields enforced
- String length limits
- Enum validation (category, status)
- JSONB schema validation (RecurringSchedule)

**Client-Side** (React + Zod):
- Pre-submission validation
- User-friendly error messages
- Prevents invalid API calls

---

## Deployment Considerations

### Environment Variables

**Backend** (apps/api):
```bash
DATABASE_URL=postgresql://user:pass@host:5432/db
TEST_DATABASE_URL=postgresql://user:pass@host:5432/test_db
ENABLE_HABITS_MODULE=true  # Feature flag (Phase 2+)
```

**Frontend** (apps/web):
```bash
NEXT_PUBLIC_API_URL=https://api.example.com
```

### Database Migration

**Alembic Workflow**:
```bash
# Generate migration
cd apps/api
alembic revision -m "Create habits table"

# Apply migration (local)
alembic upgrade head

# Apply migration (production via Render)
# Auto-applied on deployment
```

**Rollback Strategy**:
```bash
# Rollback last migration
alembic downgrade -1

# Rollback to specific version
alembic downgrade <revision_id>
```

### Deployment Sequence

1. **Backend Deployment** (Render):
   - Run Alembic migration (create habits table)
   - Deploy FastAPI code with new routes
   - Verify `/docs` shows new endpoints

2. **Frontend Deployment** (Vercel):
   - Deploy Next.js code with habits pages
   - Verify navigation to `/habits` works
   - Test API integration

3. **Verification**:
   - Create test habit via UI
   - Verify habit appears in database
   - Check event logs for HABIT_CREATED

---

## Risk Analysis & Mitigation

### Risk 1: SQLModel Field Definition Pitfalls

**Risk**: RuntimeError if Field() params mixed with sa_column params

**Likelihood**: Medium (common pitfall per CLAUDE.md)

**Impact**: High (blocks all database operations)

**Mitigation**:
- ‚úÖ Follow documented pattern: ALL attributes inside Column()
- ‚úÖ Reference existing task.py model as template
- ‚úÖ Run unit tests immediately after model creation

**Detection**: Unit tests fail on model import

---

### Risk 2: Circular Dependency Validation

**Risk**: Users create circular habit stacking (A ‚Üí B ‚Üí A)

**Likelihood**: Low (requires intentional setup)

**Impact**: Medium (breaks dependency tree, confuses UI)

**Mitigation**:
- ‚úÖ Implement recursive validation in HabitService
- ‚úÖ Block circular dependencies at API level (400 error)
- ‚úÖ Add integration test for circular dependency attempt

**Detection**: Integration test `test_prevent_circular_dependency`

---

### Risk 3: PostgreSQL Requirement for Tests

**Risk**: Tests fail with SQLite (JSONB/ARRAY not supported)

**Likelihood**: High (if TEST_DATABASE_URL not set)

**Impact**: Medium (all tests fail, but easy to fix)

**Mitigation**:
- ‚úÖ Document in quickstart.md
- ‚úÖ Add check in conftest.py to skip if SQLite
- ‚úÖ CI/CD uses PostgreSQL for tests

**Detection**: pytest.skip in conftest.py if DATABASE_URL missing

---

## Success Criteria

### Definition of Done (Backend)

- [ ] `habits` table created with all fields and indexes
- [ ] Habit SQLModel with validators implemented
- [ ] HabitService with CRUD + circular dependency validation
- [ ] All REST endpoints working (POST, GET, PATCH, DELETE)
- [ ] Events emitted for all CRUD operations
- [ ] Unit tests passing (90%+ coverage)
- [ ] Integration tests passing (100% endpoint coverage)
- [ ] OpenAPI docs auto-generated at `/docs`

### Definition of Done (Frontend)

- [ ] Habits list page rendering user's habits
- [ ] Create habit form with all required fields
- [ ] Habit detail/edit page working
- [ ] Category and status filters functional
- [ ] Navigation between pages smooth
- [ ] Error handling and loading states
- [ ] Component tests passing (80%+ coverage)

### Definition of Done (Integration)

- [ ] End-to-end flow: Create ‚Üí List ‚Üí Edit ‚Üí Archive ‚Üí Delete
- [ ] User isolation verified (cannot see other users' habits)
- [ ] Circular dependency blocked
- [ ] Delete warning shows dependent habits
- [ ] Performance targets met (API < 200ms p95)

---

## Follow-Up Work

### Immediate (Phase 2 Chunk 4)

**Habit Tracking & Streaks**:
- Implement `habit_completions` table
- Build completion logging endpoint (POST `/api/{user_id}/habits/{id}/complete`)
- Calculate streaks (consecutive days)
- Implement "never miss twice" logic
- Add notifications for missed habits

**References**: Phase 2 Chunk 4 spec (to be created)

### Post-Phase V Enhancements

**Advanced Atomic Habits Features**:
- Implementation intentions (time/location triggers)
- Habit bundles (pair necessary + enjoyable)
- Tracking calendar heatmap
- Milestone celebrations (21, 66, 100 days)
- Compound growth visualization
- Voice commands for completion logging

**References**: Constitution Post-Phase V roadmap

---

## Architectural Decision Records (ADR)

### ADR Suggestion

üìã **Architectural decision detected**: JSONB for recurring schedules, foreign key for habit stacking, fixed category enum for Phase 2, event-driven integration

**Recommendation**: These decisions have long-term architectural impact. Document reasoning and tradeoffs?

**Command**: `/sp.adr habit-data-model-decisions`

**Rationale**:
- **Impact**: Database schema affects all future habit features
- **Alternatives**: Multiple viable approaches considered (see Key Architectural Decisions)
- **Scope**: Cross-cutting design (affects backend, frontend, testing, performance)

---

## References

### Internal Documentation

- **Feature Spec**: [spec.md](./spec.md)
- **Research**: [research.md](./research.md)
- **Data Model**: [data-model.md](./data-model.md)
- **API Contract**: [contracts/habits-api.yaml](./contracts/habits-api.yaml)
- **Quickstart**: [quickstart.md](./quickstart.md)
- **Constitution**: [.specify/memory/constitution.md](../../.specify/memory/constitution.md)

### Code References

- **Existing Task Model**: [apps/api/src/models/task.py](../../apps/api/src/models/task.py)
- **Existing Task Service**: [apps/api/src/services/task_service.py](../../apps/api/src/services/task_service.py)
- **Existing Task Routes**: [apps/api/src/routes/tasks.py](../../apps/api/src/routes/tasks.py)
- **Event Emitter**: [apps/api/src/services/event_emitter.py](../../apps/api/src/services/event_emitter.py)
- **Test Patterns**: [apps/api/tests/conftest.py](../../apps/api/tests/conftest.py)

### External Resources

- [PostgreSQL JSONB Best Practices | AWS](https://aws.amazon.com/blogs/database/postgresql-as-a-json-database-advanced-patterns-and-best-practices/)
- [SQLModel Documentation](https://sqlmodel.tiangolo.com)
- [FastAPI Documentation](https://fastapi.tiangolo.com)
- [Atomic Habits Book](https://jamesclear.com/atomic-habits)

---

**Plan Status**: ‚úÖ **COMPLETE**

**Next Step**: Run `/sp.tasks` to generate actionable task list in `tasks.md`

**Estimated Implementation Time**: 3-5 days (Backend: 2 days, Frontend: 2 days, Testing: 1 day)

**Branch**: `003-habits-mvp`

**Assigned To**: Development team (via spec-driven workflow)
