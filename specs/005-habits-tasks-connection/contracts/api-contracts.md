# API Contracts: Habits ↔ Tasks Connection

**Feature**: 005-habits-tasks-connection
**Date**: 2026-02-13
**Base URL**: `/api`

---

## Modified Endpoints

### PATCH `/{user_id}/tasks/{task_id}/complete` (EXTENDED)

**Existing**: Marks a task as completed.
**Extension**: Accepts optional `completion_type` query param. When the completed task is habit-generated (`generated_by_habit_id` is not NULL and habit still exists), also creates a habit completion record and returns streak info.

**Request**:
```
PATCH /api/{user_id}/tasks/{task_id}/complete?completion_type=full
```

| Param | Location | Type | Required | Default | Notes |
|-------|----------|------|----------|---------|-------|
| `user_id` | path | UUID | yes | — | |
| `task_id` | path | UUID | yes | — | |
| `completion_type` | query | string | no | `"full"` | `"full"` or `"two_minute"`. Only used for habit-generated tasks. |

**Response** `200 OK`:
```json
{
  "id": "uuid",
  "user_id": "uuid",
  "title": "Run 5km",
  "description": "Full: Run 5km\n2-min: Put on running shoes",
  "status": "completed",
  "priority": null,
  "tags": ["Health & Fitness", "habit-generated"],
  "due_date": "2026-02-14T00:00:00Z",
  "completed": true,
  "is_habit_task": true,
  "generated_by_habit_id": "uuid",
  "created_at": "2026-02-13T00:01:00Z",
  "updated_at": "2026-02-14T10:30:00Z",
  "habit_sync": {
    "synced": true,
    "habit_id": "uuid",
    "new_streak": 5,
    "completion_type": "full",
    "message": "Great! Your habit streak for 'I am a runner' is now 5 days"
  }
}
```

When the task is NOT habit-generated, `habit_sync` is `null`.
When the habit has been deleted (FK is NULL), `habit_sync` is `null`.
When the habit was already completed today (409 from habit completion), `habit_sync.synced` is `false` with a message.

**Error responses**: Same as existing (403, 404, 500).

---

### GET `/{user_id}/tasks` (EXTENDED)

**Extension**: Accepts optional `is_habit_task` query param for filtering.

**New query params**:

| Param | Type | Required | Default | Notes |
|-------|------|----------|---------|-------|
| `is_habit_task` | boolean | no | — | `true` = only habit-generated tasks; `false` = only manual tasks; absent = all tasks |

**Response**: Same as existing `TaskListResponse`, but each task now includes `is_habit_task` and `generated_by_habit_id` fields.

---

## New Endpoints

### GET `/{user_id}/habits/{habit_id}/generated-tasks`

**Description**: List all tasks generated by a specific habit.

**Request**:
```
GET /api/{user_id}/habits/{habit_id}/generated-tasks?status=pending&page=1&limit=20
```

| Param | Location | Type | Required | Default | Notes |
|-------|----------|------|----------|---------|-------|
| `user_id` | path | UUID | yes | — | |
| `habit_id` | path | UUID | yes | — | |
| `status` | query | string | no | — | Filter: `pending`, `completed`, or absent for all |
| `page` | query | int | no | 1 | |
| `limit` | query | int | no | 20 | Max 100 |

**Response** `200 OK`:
```json
{
  "tasks": [
    {
      "id": "uuid",
      "user_id": "uuid",
      "title": "Run 5km",
      "description": "Full: Run 5km\n2-min: Put on running shoes",
      "status": "pending",
      "priority": null,
      "tags": ["Health & Fitness", "habit-generated"],
      "due_date": "2026-02-14T00:00:00Z",
      "completed": false,
      "is_habit_task": true,
      "generated_by_habit_id": "uuid",
      "created_at": "2026-02-13T00:01:00Z",
      "updated_at": "2026-02-13T00:01:00Z"
    }
  ],
  "total": 7,
  "page": 1,
  "limit": 20
}
```

**Error responses**:
- `403 Forbidden`: User does not own habit
- `404 Not Found`: Habit not found

---

### POST `/{user_id}/habits/{habit_id}/generate-tasks`

**Description**: Manually trigger task generation for a habit (developer/testing endpoint).

**Request**:
```
POST /api/{user_id}/habits/{habit_id}/generate-tasks
```

| Param | Location | Type | Required | Default | Notes |
|-------|----------|------|----------|---------|-------|
| `user_id` | path | UUID | yes | — | |
| `habit_id` | path | UUID | yes | — | |

**Request body** (optional):
```json
{
  "lookahead_days": 7
}
```

**Response** `200 OK`:
```json
{
  "generated": 5,
  "skipped": 2,
  "habit_id": "uuid",
  "dates_generated": ["2026-02-13", "2026-02-14", "2026-02-15", "2026-02-16", "2026-02-17"],
  "dates_skipped": ["2026-02-18", "2026-02-19"],
  "message": "Generated 5 tasks, skipped 2 (already exist)"
}
```

**Error responses**:
- `403 Forbidden`: User does not own habit
- `404 Not Found`: Habit not found
- `400 Bad Request`: Habit has no recurring schedule, or `until` date is in the past

---

## Response Schema Updates

### TaskResponse (EXTENDED)

Add two new fields to the existing `TaskResponse` schema:

```python
class TaskResponse(BaseModel):
    # ... existing fields ...
    is_habit_task: bool = False
    generated_by_habit_id: Optional[UUID] = None
    habit_sync: Optional[HabitSyncResponse] = None  # Only on completion response
```

### HabitSyncResponse (NEW)

```python
class HabitSyncResponse(BaseModel):
    synced: bool
    habit_id: Optional[str] = None
    new_streak: Optional[int] = None
    completion_type: Optional[str] = None
    message: str
```

### GenerateTasksRequest (NEW)

```python
class GenerateTasksRequest(BaseModel):
    lookahead_days: int = Field(default=7, ge=1, le=30)
```

### GenerateTasksResponse (NEW)

```python
class GenerateTasksResponse(BaseModel):
    generated: int
    skipped: int
    habit_id: str
    dates_generated: list[str]
    dates_skipped: list[str]
    message: str
```

---

## Event Contracts

### HABIT_GENERATES_TASK (NEW)

Emitted each time a task is created from a habit (both background job and manual trigger).

```json
{
  "event_type": "HABIT_GENERATES_TASK",
  "user_id": "uuid-string",
  "timestamp": "2026-02-13T00:01:00Z",
  "payload": {
    "habit_id": "uuid-string",
    "task_id": "uuid-string",
    "task_title": "Run 5km (from habit: I am a runner)",
    "due_date": "2026-02-13",
    "recurring_schedule": {
      "type": "daily",
      "frequency": 1
    }
  },
  "log_level": "info"
}
```

Emitted via existing `EventEmitter.emit()` — file-based JSON logging, same as all other events.
