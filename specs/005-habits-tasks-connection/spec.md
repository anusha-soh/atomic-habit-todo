# Feature Specification: Habits ↔ Tasks Connection

**Feature Branch**: `005-habits-tasks-connection`
**Created**: 2026-02-13
**Status**: Draft
**Phase**: Phase 2, Chunk 5 of 7

## Overview

This feature connects habits to tasks by enabling habits with recurring schedules to automatically generate daily task instances. Completing a habit-generated task automatically updates the habit's streak. This is the core relationship: "A habit can generate daily task instances."

**Depends on**: Chunk 1 (Core Infrastructure), Chunk 2 (Tasks CRUD), Chunk 3 (Habits CRUD), Chunk 4 (Habit Tracking & Streaks)

---

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Habit Creates Daily Tasks Automatically (Priority: P1)

A user creates a habit with a recurring schedule (daily, weekly, or monthly). The system automatically generates task instances for the next 7 days based on the schedule. The user sees these tasks in their task list, visually identified as habit-generated tasks.

**Why this priority**: This is the foundational value of the feature — automating task creation from habits eliminates manual effort and ensures habits translate into actionable daily work.

**Independent Test**: Can be tested by creating a habit with `type: daily, frequency: 1`, then verifying 7 tasks appear in the task list with `is_habit_task=true` and the correct due dates.

**Acceptance Scenarios**:

1. **Given** a user creates a habit with `recurring_schedule: { type: "daily", frequency: 1 }`, **When** the habit is saved, **Then** 7 tasks are generated with due dates for the next 7 days, each tagged with the habit's category and "habit-generated".
2. **Given** a habit with `type: "weekly", days_of_week: [1, 3, 5]`, **When** the habit is created, **Then** tasks are only generated for Monday, Wednesday, and Friday dates within the 7-day lookahead window.
3. **Given** a habit with `type: "monthly", days_of_month: [1, 15]`, **When** the habit is created, **Then** tasks are only generated for the 1st and 15th of the current/next month within the 7-day window.
4. **Given** a habit with an `until` date already in the past, **When** the habit is created, **Then** no tasks are generated.
5. **Given** the same habit + due_date combination already has a generated task, **When** task generation is triggered again, **Then** no duplicate task is created.

---

### User Story 2 - Completing Habit Task Updates Streak Automatically (Priority: P1)

A user marks a habit-generated task as complete. The system automatically updates the corresponding habit's streak without requiring the user to separately mark the habit complete.

**Why this priority**: This is the core habit-task synchronization that makes the connection meaningful — removing the burden of double-entry and ensuring streak integrity.

**Independent Test**: Complete a habit-generated task and verify the linked habit's streak count increments by 1 in the habit detail view.

**Acceptance Scenarios**:

1. **Given** a task with `generated_by_habit_id` pointing to an active habit, **When** the user marks the task complete, **Then** the linked habit receives a completion record and the streak updates.
2. **Given** a task has both a full description and a 2-minute version, **When** the user completes the task, **Then** a modal appears asking "Did you complete the full habit or 2-minute version?" and the user's selection is recorded as the `completion_type`.
3. **Given** the user dismisses the completion type modal without selecting, **When** the task is marked complete, **Then** `completion_type` defaults to "full" and the streak updates.
4. **Given** a task with `generated_by_habit_id` where the habit has since been deleted, **When** the user marks the task complete, **Then** the task completes successfully and no error occurs (graceful degradation).
5. **Given** a streak confirmation, **When** the habit streak updates, **Then** the user sees a success message: "Great! Your habit streak for '[Habit Name]' is now [X] days".

---

### User Story 3 - Habit Detail Shows Generated Tasks (Priority: P2)

A user views a habit's detail page and sees a "Generated Tasks" section listing all upcoming tasks generated by that habit.

**Why this priority**: Provides transparency into the habit-task relationship, helping users understand what tasks are scheduled without navigating away from their habit view.

**Independent Test**: Navigate to a habit detail page for a habit with a recurring schedule and verify the "Generated Tasks" section displays the correct upcoming tasks.

**Acceptance Scenarios**:

1. **Given** a habit with 5 generated tasks, **When** the user views the habit detail page, **Then** the "Generated Tasks" section shows all 5 tasks with their due dates and completion status.
2. **Given** a habit with no recurring schedule (or all tasks completed), **When** the user views the habit detail page, **Then** the "Generated Tasks" section shows an empty state message.

---

### User Story 4 - Recurring Schedule Update Regenerates Future Tasks (Priority: P2)

A user updates a habit's recurring schedule (e.g., changes from daily to weekly). The system deletes all future pending tasks generated by this habit and regenerates new tasks based on the updated schedule.

**Why this priority**: Ensures the task queue stays accurate when habits evolve, preventing stale tasks from cluttering the user's list.

**Independent Test**: Update a daily habit's schedule to weekly (Mon/Wed/Fri), verify past completed tasks are unchanged, and future pending tasks reflect the new schedule.

**Acceptance Scenarios**:

1. **Given** a daily habit with 5 future pending tasks, **When** the user changes the schedule to weekly (Mon/Wed/Fri), **Then** the old pending tasks are deleted and new tasks for Mon/Wed/Fri are generated for the next 7 days.
2. **Given** a daily habit with 1 completed task from yesterday and 4 future pending tasks, **When** the schedule is updated, **Then** the completed task remains unchanged and only future pending tasks are replaced.

---

### User Story 5 - Habit Deletion Orphans Tasks (Priority: P2)

A user deletes a habit. All tasks previously generated by that habit remain in the task list but are no longer linked to the habit.

**Why this priority**: Prevents data loss — users may have already partially completed tasks and shouldn't lose their task history when a habit is removed.

**Independent Test**: Delete a habit that has generated tasks, verify the tasks still appear in the task list with `generated_by_habit_id = null`.

**Acceptance Scenarios**:

1. **Given** a habit with 3 generated tasks (1 completed, 2 pending), **When** the user deletes the habit, **Then** all 3 tasks remain in the task list with no linked habit.
2. **Given** an orphaned task (habit deleted) that is still pending, **When** the user completes the task, **Then** the task completes normally with no habit streak update and no error.

---

### User Story 6 - Daily Background Job Generates Today's Tasks (Priority: P2)

A background job runs daily at 00:01 UTC and generates tasks for today and the next 6 days for all active habits with recurring schedules.

**Why this priority**: Ensures new tasks appear automatically each day without user action, keeping the task queue populated ahead of time.

**Independent Test**: Trigger the background job manually, verify tasks are created for today's date for all active habits with matching schedule days, with no duplicates.

**Acceptance Scenarios**:

1. **Given** an active daily habit with no task for today, **When** the background job runs, **Then** a task is created with `due_date = today`.
2. **Given** a weekly habit scheduled for Monday, **When** the background job runs on a Tuesday, **Then** no task is created for today (Tuesday is not scheduled).
3. **Given** a habit where `until` date is yesterday, **When** the background job runs, **Then** the habit is skipped and no task is created.
4. **Given** a daily habit already has a task for today, **When** the background job runs, **Then** no duplicate task is created.

---

### User Story 7 - Manual Habit Completion Does Not Affect Tasks (Priority: P3)

A user marks a habit complete directly via the habit list (not via a generated task). The habit streak updates, but no task is affected.

**Why this priority**: Preserves independence between the two completion paths. Users should be able to track habits directly without their task queue changing unexpectedly.

**Independent Test**: Mark a habit complete directly and verify the habit streak increases while any pending habit-generated tasks remain pending.

**Acceptance Scenarios**:

1. **Given** a habit with a pending generated task for today, **When** the user marks the habit complete directly, **Then** the habit streak updates but the pending task remains pending.
2. **Given** a habit with a pending generated task for today, **When** the user marks the task complete, **Then** the habit streak updates but the user cannot manually mark the habit complete twice for the same day.

---

### User Story 8 - Filter Task List by Habit Tasks (Priority: P3)

A user can filter the task list to show only habit-generated tasks using a toggle.

**Why this priority**: Improves focus — users who want to see their habit work vs. project work can filter accordingly.

**Acceptance Scenarios**:

1. **Given** a task list with 5 regular tasks and 3 habit tasks, **When** the user enables "Show habit tasks only", **Then** only the 3 habit-generated tasks are displayed.
2. **Given** the habit task filter is active, **When** the user disables the filter, **Then** all tasks are shown again.

---

### Edge Cases

- **Same title as manual task**: A manually created task with the same title as a habit-generated task coexists independently. Manual task has `is_habit_task=false`; habit task has `is_habit_task=true`.
- **Habit deleted, tasks exist**: Tasks remain with `generated_by_habit_id = null`. User can complete them, but no habit streak updates.
- **Completing orphaned task**: Task completes normally; no habit completion call is made; no error is raised.
- **Schedule updated mid-month**: Only future pending tasks are affected. Past completed or in-progress tasks remain unchanged.
- **`until` date in the past**: No tasks are generated; background job skips this habit silently.
- **High volume (50+ daily habits)**: Background job uses batch processing to avoid performance degradation. Monitor and log job duration.
- **Task generation database error**: Log error, skip the failing habit, continue processing remaining habits. Job does not fail entirely.
- **Timezone travel**: System uses UTC consistently for all `due_date` values. Frontend displays dates in the user's local timezone.
- **`until` date equals today**: Task IS generated for today; no tasks generated from tomorrow onward.

---

## Requirements *(mandatory)*

### Functional Requirements

**Task Generation**

- **FR-001**: System MUST generate tasks for the next 7 days when a habit with a recurring schedule is created.
- **FR-002**: Task generation MUST be idempotent — duplicate tasks for the same habit + due_date combination MUST NOT be created.
- **FR-003**: System MUST run a background job daily at 00:01 UTC that generates tasks for today and the next 6 days for all active habits.
- **FR-004**: Generated tasks MUST include the habit's full description and 2-minute version in the task description field.
- **FR-005**: Generated tasks MUST be tagged with the habit's category and a "habit-generated" tag.
- **FR-006**: Task generation MUST respect the `until` date — no tasks may be generated after the `until` date.
- **FR-007**: When a habit's recurring schedule is updated, future pending tasks MUST be deleted and regenerated based on the new schedule. Past completed tasks MUST NOT be modified.
- **FR-008**: System MUST provide a manual task generation trigger (API endpoint) for testing and debugging purposes.

**Habit-Task Linking**

- **FR-009**: Each generated task MUST store the ID of the habit that created it.
- **FR-010**: Habit deletion MUST NOT delete generated tasks. The task's habit reference MUST be set to null instead.
- **FR-011**: Tasks MUST carry a flag distinguishing habit-generated tasks from manually created tasks.

**Completion Synchronization**

- **FR-012**: When a user completes a habit-generated task, the system MUST automatically update the corresponding habit's streak.
- **FR-013**: If a habit-generated task description includes a 2-minute version, the system MUST prompt the user to select full or 2-minute completion before updating the streak.
- **FR-014**: If the user does not select a completion type, the system MUST default to "full" completion.
- **FR-015**: Completing a habit-generated task whose habit has been deleted MUST complete the task normally without raising errors.
- **FR-016**: Completing a habit directly (not via task) MUST NOT affect any generated tasks.

**Recurring Schedule**

- **FR-017**: System MUST support daily schedules with configurable frequency (every N days).
- **FR-018**: System MUST support weekly schedules with specific days of the week.
- **FR-019**: System MUST support monthly schedules with specific days of the month.
- **FR-020**: Recurring schedule configuration MUST be stored as flexible structured data (not hardcoded values).

**Events**

- **FR-021**: System MUST emit a `HABIT_GENERATES_TASK` event each time a task is created from a habit, including habit ID, task ID, task title, due date, and schedule details.

**Frontend**

- **FR-022**: Habit-generated tasks MUST display a visual badge/indicator (e.g., "Habit") in the task list distinguishing them from manual tasks.
- **FR-023**: The task list MUST include a filter toggle to display only habit-generated tasks.
- **FR-024**: After completing a habit-generated task and updating the streak, the user MUST see a confirmation message showing the updated streak count.
- **FR-025**: The habit detail page MUST include a "Generated Tasks" section listing all tasks created by that habit.
- **FR-026**: The habit creation form MUST inform the user that tasks will be automatically created from the recurring schedule.

### Key Entities

- **Habit**: Existing entity extended with a recurring schedule configuration (daily/weekly/monthly with frequency and optional end date). Remains the source of truth for streak tracking.
- **Task**: Existing entity extended with two new fields: a reference to the originating habit (nullable) and a boolean flag for habit-generated status.
- **RecurringSchedule**: A structured configuration embedded in the habit entity defining schedule type, frequency, applicable days, and optional end date.
- **HabitGeneratesTaskEvent**: An event record emitted each time a task is created from a habit, capturing the relationship and schedule context.
- **GenerateHabitTasksJob**: A scheduled background process that runs daily, queries all active habits with recurring schedules, calculates applicable dates, and creates tasks where none exist.

---

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 100% of habits with a recurring schedule generate tasks automatically within 1 minute of creation — no manual user action required.
- **SC-002**: Task generation is fully idempotent — running the generation process multiple times for the same habit and date window results in zero duplicate tasks.
- **SC-003**: Completing a habit-generated task updates the habit streak within 2 seconds on standard mobile connections.
- **SC-004**: The daily background job completes task generation for up to 50 active habits in under 30 seconds.
- **SC-005**: 100% of habits where the `until` date has passed produce zero new generated tasks.
- **SC-006**: Deleting a habit results in zero deleted tasks — all previously generated tasks remain accessible.
- **SC-007**: Users can identify habit-generated tasks at a glance in the task list via a visual indicator (0 misidentification in usability test).
- **SC-008**: Completing a habit-generated task while the originating habit no longer exists produces zero error messages visible to the user.
- **SC-009**: All `HABIT_GENERATES_TASK` events are emitted with complete payload data for every task generation action.
- **SC-010**: The habit detail page loads its "Generated Tasks" section within 1 second under normal usage conditions.

---

## Assumptions

- The recurring schedule JSONB format is flexible enough to accommodate future schedule types without schema migration.
- UTC is the canonical timezone for all date calculations; frontend is responsible for timezone display.
- "Active habit" is defined as a habit with `status = active` (or equivalent) and a non-null `recurring_schedule`.
- The 7-day lookahead window is a product decision; future chunks may extend this without spec changes.
- Performance baseline assumes up to 50 daily habits per user; bulk insert optimization is recommended but not required for initial delivery.
- Task description format for habit tasks: `"Full: [full_description]\n2-min: [two_minute_version]"`. The "2-min:" keyword is the detection signal for the completion type modal.
- The manual task generation endpoint is developer-facing and does not require special UI — it is an API endpoint only.
- Background job scheduling mechanism (cron, task queue, etc.) is a technical implementation decision deferred to the plan phase.

---

## Out of Scope

- Task reminders and push notifications for habit tasks
- Habit task templates with custom priority or metadata
- Recurring patterns beyond daily, weekly, and monthly
- Task dependencies between habit-generated tasks
- Bulk task generation UI (background job handles this automatically)
- Analytics or reporting on habit-task completion rates

---

## Dependencies

- **Chunk 2**: Task CRUD operations, task completion logic, `TASK_COMPLETED` event
- **Chunk 3**: Habit data model, habit CRUD, recurring schedule field
- **Chunk 4**: Habit completion endpoint, streak calculation, `HABIT_COMPLETED` event
